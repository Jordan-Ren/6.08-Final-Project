<!DOCTYPE html>
<html>
<head>
  <title>Spotify Web Playback SDK Quick Start Tutorial</title>
</head>
<body>
  <h1>Spartify Web Playback</h1>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>

  <h2>Group ID</h2>
  <p id="groupID"></p>
  <h2>Spartify Queue</h2>
  <h3>Current Song</h3>
  <p id="currentSong">No current song</p>
  <h3>Upcoming Songs </h3>
  <ol>
    <li id="nextSong">No next song queued</li>
    <li id="nextnextSong">No next next song queued</li>
  </ol>
  <p id="queue"></p>

  <!-- <form action="">
    <select name="customers" onchange="getQueue(this.value)">
      <option value="">Select a customer:</option>
      <option value="ALFKI">Alfreds Futterkiste</option>
      <option value="NORTS ">North/South</option>
      <option value="WOLZA">Wolski Zajazd</option>
    </select>
  </form> -->
  <!-- <button type="button" onclick="getQueue()">Get Queue</button>
  <br> -->
  <div id="txtHint">Queue info will be listed here...</div>

  <!-- <script type="text/javascript" src="jquery-1.8.1.min.js"></script> -->
  <script>
    var groupID = "defaultGroupID";
    window.onSpotifyWebPlaybackSDKReady = () => {
      groupID = prompt("Input Group ID");
      document.getElementById('groupID').innerHTML = groupID;
      var groupTokens = new Map();
      groupTokens.set("test1", {spotify_token: 'BQA89clj-lYRl2fjgd5-s5PEN6WBwX_620x8ispWrfn_vRlj2YNG6fufQE6rcozfCIL5Bg0AkzR331KigKBWUomU_Oh610Wola3zvBIFzFbB5FIIB-yY94q7-L_r1UGVmHSasiZ6KT1dqal42xJwJqGFkCBa4lbM9_SHyWfD8WBmb1z2bZcIGOQ'});
      groupTokens.set("brandon", {spotify_token: 'BQA89clj-lYRl2fjgd5-s5PEN6WBwX_620x8ispWrfn_vRlj2YNG6fufQE6rcozfCIL5Bg0AkzR331KigKBWUomU_Oh610Wola3zvBIFzFbB5FIIB-yY94q7-L_r1UGVmHSasiZ6KT1dqal42xJwJqGFkCBa4lbM9_SHyWfD8WBmb1z2bZcIGOQ'});
      var groupName = document.getElementById('groupID').innerHTML;
      console.log("Group ID", groupID);
      console.log("Group Token", groupTokens.get(groupName));
      const player = new Spotify.Player({
        name: 'Web Player',
        getOAuthToken: cb => { cb(groupTokens.get(groupName).spotify_token);}
      });

      // Error handling
      player.addListener('initialization_error', ({ message }) => { console.error(message); });
      player.addListener('authentication_error', ({ message }) => { console.error(message); });
      player.addListener('account_error', ({ message }) => { console.error(message); });
      player.addListener('playback_error', ({ message }) => { console.error(message); });

      // Playback status updates
      player.addListener('player_state_changed', state => {
        console.log(state);
        document.getElementById('currentSong').innerHTML = "Current Song: " + state.track_window.current_track.name + " by " + state.track_window.current_track.artists[0].name;
        for(var i = 0; i < state.track_window.next_tracks.length; i++) {
          console.log(state.track_window.next_tracks[i].name);
          if(i == 0) {
            document.getElementById('nextSong').innerHTML = state.track_window.next_tracks[i].name + " by " + state.track_window.next_tracks[i].artists[0].name;
          } else if(i == 1) {
            document.getElementById('nextnextSong').innerHTML = state.track_window.next_tracks[i].name + " by " + state.track_window.next_tracks[i].artists[0].name;
          }
        }
      });

      // Ready
      player.addListener('ready', ({ device_id }) => {
        console.log('Ready with Device ID', device_id);
      });

      // Not Ready
      player.addListener('not_ready', ({ device_id }) => {
        console.log('Device ID has gone offline', device_id);
      });

      // Connect to the player!
      player.connect();
      getQueue();
      setInterval(getQueue, 1000)
    };

  function getQueue(str) {
    var xhttp;
    // if (str == "") {
    //   document.getElementById("txtHint").innerHTML = "";
    //   return;
    // }
    xhttp = new XMLHttpRequest();
    var groupName = document.getElementById('groupID').innerHTML;
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        document.getElementById("txtHint").innerHTML = this.responseText;
      }
    };
    xhttp.open("GET", "http://608dev-2.net/sandbox/sc/team15/final/voice_text_input_with_secrets.py?group="+groupName, true);
    xhttp.send();
  }


  </script>
</body>
</html>
